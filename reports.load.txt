Option Compare Database
Option Explicit

'These variables must load first, in this sequence.
Public Type typ_app_continents
    eur_asia As String
    americas As String
    global As String
End Type
Public app_continents As Load.typ_app_continents
Public sources As New cls_sources
Public conn As New ADODB.Connection

'objects
Public system_info As New cls_system_info
Public colors As New cls_colors
Public current_uw As New cls_underwriter

'non-object variables
Public i As Long
Public is_debugging As Boolean
Public is_init As Boolean
Public underwriters() As Variant

'MenuListT constants
Public Const no As Integer = 94
Public Const yes As Integer = 93
Public Const rp_denmark As Integer = 76
Public Const rp_norway As Integer = 77
Public Const rp_sweden As Integer = 78
Public Const rp_finland As Integer = 82
Public Const super_sector As Integer = 494
Public Const sector_bucket As Integer = 615

'misc
Public call_stack As String

Public Sub start_reports()
    Dim proc_name As String
    proc_name = "load.start_reports"
    Load.call_stack = Load.call_stack & vbNewLine & proc_name
    
    windows_apis.AccessMoveSize 0, 0, 400, 150
outro:
    Exit Sub

End Sub
Public Sub init_global_variables()
    Load.call_stack = Load.call_stack & vbNewLine & "load.init_global_variables"
    is_init = True
End Sub
Public Sub exit_app()
    If Not conn Is Nothing Then Set conn = Nothing
    If Not current_uw Is Nothing Then Set current_uw = Nothing
    If Not sources Is Nothing Then Set sources = Nothing
    If Not Load.system_info Is Nothing Then Set Load.system_info = Nothing
End Sub

Public Sub init_conn()
    Load.call_stack = Load.call_stack & vbNewLine & "load.init_conn"
    Dim database_name As String
    Dim encryption_key As Long
    Dim ip_address As String
    Dim server_name As String
    Dim user_name As String
    Dim pwd As String
    
    If Load.system_info.is_init = False Then
        Load.system_info.init_system_info
    End If
    
    'default values
    database_name = Load.system_info.database_name
    encryption_key = 33
    ip_address = "mysql01-weu-prd.rpgroup.com"
    server_name = "public_avd_db"
    user_name = "stella"
    
    'get password
    Dim pw_file As Integer
    pw_file = FreeFile
    Dim file_path As String
    file_path = Load.system_info.system_paths.pws & "\" & server_name & ".txt"
    Dim encrypted_string As String
    Open file_path For Input As FreeFile
        encrypted_string = Input(LOF(pw_file), pw_file)
        pwd = CStr(utilities.decrypt_string(encrypted_string, Left(encryption_key, 1), Right(encryption_key, 1)))
    Close pw_file
    
    'reset connection
    If Not Load.conn Is Nothing Then Set Load.conn = Nothing
    
    'activate connection
    Dim str_conn As String
    str_conn = "Driver={MySQL ODBC 8.0 Unicode Driver};" _
        & "Server=" & ip_address & ";" _
        & "DATABASE=" & database_name & ";" _
        & "UID=" & user_name & ";" _
        & "PWD=" & pwd
    Set Load.conn = New ADODB.Connection
    
    With conn
        .ConnectionString = str_conn
        .Open
        .CursorLocation = adUseClient
    End With
    
End Sub
Public Sub check_conn_and_variables()
    Load.call_stack = Load.call_stack & vbNewLine & "load.check_conn_and_variables"
    On Error GoTo err_handler
    If Load.is_debugging = True Then On Error GoTo 0
    
    Load.system_info.init_system_info
    If conn Is Nothing Then Load.init_conn
    'connections often drops while conn.state remain 1. The .close and .open seems to fix that.
    If conn.State <> adStateClosed Then
        conn.Close
    End If
    On Error GoTo conn_fix
    conn.Open
    On Error GoTo err_handler
    If Load.is_debugging = True Then On Error GoTo 0
    If is_init = False Then Load.init_global_variables
    
outro:
    Exit Sub
    
conn_fix:
    Debug.Print Time & " conn.open failed and was reinitialised"
    Load.init_conn
    Resume Next
    
err_handler:
    Dim err_object As cls_err_object
    Set err_object = New cls_err_object
    With err_object
        .routine_name = "load.check_conn_and_variables"
        .milestone = "n/a"
        .params = "n/a"
        .system_error_code = Err.Number
        .system_error_text = Err.Description
        .send_error err_object
    End With
    
    GoTo outro
    
End Sub

